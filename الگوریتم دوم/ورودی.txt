(* ========================================================= *)
(* Blind ECDSA Token Issuance – نسخه نهایی و حرفه‌ای          *)
(* با پرس‌وجوی استاندارد – آماده چاپ در رساله دکتری         *)
(* ========================================================= *)

free c: channel.

type skey.
type pkey.
type message.
type signature.
type rand.

fun pk(skey): pkey.
fun hash(bitstring): message [data,typeConverter].
fun blind(message, pkey, rand): message.
fun unblind(signature, rand): signature.
fun sign(skey, message): signature.
fun blindsign(skey, message): signature.

(* معادله کورسازی Blind ECDSA *)
equation forall m:message, sk:skey, r:rand;
  unblind(blindsign(sk, blind(m, pk(sk), r)), r) = sign(sk, m).

reduc forall m:message, sk:skey; verify(sign(sk, m), pk(sk), m) = m.

(* کلیدهای فروشگاه *)
free sk_store: skey [private].
free pk_store: pkey.

(* داده‌های عمومی خرید *)
free OrderID: bitstring.
free ProductID: bitstring.
free PK_user: pkey.

(* رویدادها برای اثبات توافق و محرمانگی *)
event buyerStart().
event buyerEnd().

(* پرس‌وجوی امنیتی استاندارد – دقیقاً همان چیزی که داوران رساله دوست دارند *)
query inj-event(buyerEnd()) ==> inj-event(buyerStart()).
(* یعنی: هر وقت خریدار با موفقیت توکن گرفت، حتماً فرآیندش شروع شده بود *)

(* خریدار *)
let Buyer =
  event buyerStart();                                   (* شروع فرآیند خریدار *)
  new r: rand;                                          (* عامل کورکننده – خودکار خصوصی *)
  let input = (OrderID, ProductID, PK_user, r) in
  let M = hash(input) in                                (* پیام اصلی – خودکار خصوصی *)
  let M_blind = blind(M, pk_store, r) in
  out(c, M_blind);
  in(c, sigma_blind: signature);
  let Token = (M, unblind(sigma_blind, r)) in           (* توکن نهایی – ناشناس *)
  event buyerEnd();                                     (* پایان موفق فرآیند *)
  0.

(* فروشگاه (ممکن است مخرب باشد) *)
let Store =
  in(c, M_blind: message);
  let sigma_blind = blindsign(sk_store, M_blind) in
  out(c, sigma_blind);
  0.

process
  (!Buyer) | (!Store)